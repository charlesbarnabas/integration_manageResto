<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Manajemen Menu</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    #edit-form.hidden {
      display: none;
    }
    #edit-form {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      background: #f9f9f9;
      max-width: 400px;
    }
    #edit-form label {
      display: block;
      margin-top: 10px;
    }
    #edit-form input, #edit-form textarea {
      width: 100%;
      padding: 5px;
      margin-top: 5px;
      box-sizing: border-box;
    }
    #edit-form button {
      margin-top: 15px;
      padding: 8px 12px;
    }
    .link {
      cursor: pointer;
      color: blue;
      text-decoration: underline;
      margin-right: 10px;
    }
    .link.delete {
      color: red;
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h2>Restoran</h2>
      <ul>
        <li>üìä Dashboard</li>
        <li class="active">üìã Menu</li>
        <li>üí≥ Transaksi</li>
        <li>‚öôÔ∏è Pengaturan</li>
      </ul>
    </aside>

    <main class="content">
      <header class="content-header">
        <h1>Manajemen Menu</h1>
        <div class="top-controls">
          <input type="text" id="search" placeholder="üîç Cari menu..." />
          <a href="/add" class="btn primary">+ Tambah Menu</a>
        </div>
      </header>

      <table class="menu-table">
        <thead>
          <tr>
            <th>Nama Menu</th>
            <th>Kategori</th>
            <th>Harga</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="menu-container"></tbody>
      </table>

      <form id="edit-form" class="hidden" onsubmit="event.preventDefault(); submitEdit();">
        <h3>Edit Menu</h3>
        <input type="hidden" id="edit-id" />
        <label for="edit-name">Nama Menu</label>
        <input type="text" id="edit-name" required />
        
        <label for="edit-price">Harga</label>
        <input type="number" id="edit-price" min="0" required />
        
        <label for="edit-description">Deskripsi</label>
        <textarea id="edit-description" rows="3"></textarea>
        
        <button type="submit" class="btn primary">Simpan Perubahan</button>
        <button type="button" onclick="document.getElementById('edit-form').classList.add('hidden')">Batal</button>
      </form>
    </main>
  </div>

  <script>
    function loadMenu() {
      fetch('/graphql', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: `{ allMenus { id name price description } }` })
      })
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById('menu-container');
        container.innerHTML = '';
        data.data.allMenus.forEach(menu => {
          const kategori = menu.name.toLowerCase().includes("nasi") || menu.name.toLowerCase().includes("spaghetti") ? 'Makanan' : 'Minuman';
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${menu.name}</td>
            <td>${kategori}</td>
            <td>Rp ${menu.price.toLocaleString('id-ID')}</td>
            <td>
              <a href="#" class="link edit" onclick="editMenu(${menu.id}, '${escapeHtml(menu.name)}', ${menu.price}, '${escapeHtml(menu.description)}')">Edit</a>
              <a href="#" class="link delete" onclick="deleteMenu(${menu.id})">Hapus</a>
            </td>
          `;
          container.appendChild(row);
        });
      });
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }

    function editMenu(id, name, price, description) {
      document.getElementById('edit-id').value = id;
      document.getElementById('edit-name').value = name;
      document.getElementById('edit-price').value = price;
      document.getElementById('edit-description').value = description;
      document.getElementById('edit-form').classList.remove('hidden');
      window.scrollTo({ top: document.getElementById('edit-form').offsetTop, behavior: 'smooth' });
    }

    function submitEdit() {
      const id = document.getElementById('edit-id').value;
      const name = document.getElementById('edit-name').value;
      const price = parseFloat(document.getElementById('edit-price').value);
      const description = document.getElementById('edit-description').value;

      fetch('/graphql', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          query: `
            mutation {
              updateMenu(id: ${id}, name: "${name.replace(/"/g, '\\"')}", price: ${price}, description: "${description.replace(/"/g, '\\"')}") {
                menu { id name }
              }
            }
          `
        })
      })
      .then(() => {
        loadMenu();
        document.getElementById('edit-form').classList.add('hidden');
      });
    }

    function deleteMenu(id) {
      if (!confirm("Yakin ingin menghapus menu ini?")) return;
      fetch('/graphql', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: `mutation { deleteMenu(id: ${id}) { ok } }` })
      }).then(() => loadMenu());
    }

    loadMenu();
  </script>
</body>
</html>
